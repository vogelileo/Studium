<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text-to-Speech Player</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Set default font to Inter for Tailwind */
      body {
        font-family: 'Inter', sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-lg bg-white shadow-xl rounded-xl p-8 space-y-6">
      <h1 class="text-3xl font-extrabold text-gray-900 text-center">
        TTS Audio Stream Player
      </h1>
      <p class="text-gray-500 text-center">
        Enter text below to convert it to speech and stream it from the backend.
      </p>

      <!-- Text Input -->
      <textarea
        id="textInput"
        class="w-full p-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm"
        rows="4"
        placeholder="Enter the text you want the agent to speak..."
      >
Hello! I am speaking through a custom API endpoint streaming MP3 data directly to your browser.</textarea
      >

      <!-- Play Button -->
      <button
        id="playButton"
        class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 flex items-center justify-center disabled:bg-blue-400 shadow-md"
      >
        <svg
          id="playIcon"
          class="w-6 h-6 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
          ></path>
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
        <svg
          id="loadingIcon"
          class="animate-spin w-6 h-6 mr-2 text-white hidden"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <span id="buttonText">Generate & Play Audio</span>
      </button>

      <!-- Status/Error Message Area -->
      <div
        id="statusMessage"
        class="min-h-8 p-3 bg-white rounded-lg transition duration-300"
      ></div>

      <!-- Hidden Audio Element for playback control (optional) -->
      <audio id="audioPlayer" class="w-full hidden"></audio>
    </div>

    <script>
      const textInput = document.getElementById('textInput');
      const playButton = document.getElementById('playButton');
      const loadingIcon = document.getElementById('loadingIcon');
      const playIcon = document.getElementById('playIcon');
      const buttonText = document.getElementById('buttonText');
      const statusMessage = document.getElementById('statusMessage');
      const audioPlayer = document.getElementById('audioPlayer');

      // NOTE: Replace '/api/tts' with the actual URL of your backend endpoint
      const TTS_ENDPOINT = 'http://localhost:3001/api/generate-voice';

      function setStatus(message, isError = false) {
        statusMessage.textContent = message;
        statusMessage.className = `min-h-8 p-3 rounded-lg transition duration-300 ${
          isError
            ? 'bg-red-100 text-red-700 border border-red-300'
            : 'bg-green-100 text-green-700 border border-green-300'
        }`;
        if (!message) {
          statusMessage.className =
            'min-h-8 p-3 bg-white rounded-lg transition duration-300';
        }
      }

      function toggleLoading(isLoading) {
        playButton.disabled = isLoading;
        loadingIcon.classList.toggle('hidden', !isLoading);
        playIcon.classList.toggle('hidden', isLoading);
        buttonText.textContent = isLoading
          ? 'Generating...'
          : 'Generate & Play Audio';
      }

      playButton.addEventListener('click', async () => {
        const text = textInput.value.trim();
        if (!text) {
          setStatus('Please enter some text to convert.', true);
          return;
        }

        // Clear previous messages and start loading
        setStatus('');
        toggleLoading(true);

        // Construct the URL to include the text as a query parameter
        const url = `${TTS_ENDPOINT}`;

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ prompt: text }),
          });

          if (!response.ok) {
            // Check if the server returned a structured JSON error (status 4xx or 5xx)
            const contentType = response.headers.get('content-type');

            if (contentType && contentType.includes('application/json')) {
              // Handle JSON error body from the backend (Steps 5 & 6 in audio_endpoint.js)
              const errorData = await response.json();
              const message = `Error ${errorData.status} (${errorData.code}): ${errorData.message}. Details: ${errorData.details}`;
              setStatus(message, true);
              console.error('Backend JSON Error:', errorData);
            } else {
              // Handle generic HTTP error (e.g., server down, network issue)
              setStatus(
                `HTTP Error: ${response.status} ${response.statusText}`,
                true
              );
              console.error(`Unknown server error: Status ${response.status}`);
            }
            toggleLoading(false);
            return;
          }
          // SUCCESS PATH: Server returned the audio stream (Status 200, Content-Type: audio/mpeg)

          // 1. Get the response body as a Blob (binary data)
          const audioBlob = await response.blob();

          if (audioBlob.size === 0) {
            console.error('Received an empty audio blob!');
            setStatus(
              'Error: Received an empty audio file from the server.',
              true
            );
            toggleLoading(false);
            return; // Stop execution here
          }
          console.log('Audio blob type:', audioBlob.type);
          console.log('Audio blob size (bytes):', audioBlob.size);

          // 2. Create a temporary URL for the browser's Audio object
          // The browser knows how to play this blob data because the server
          // sent Content-Type: audio/mpeg
          const audioUrl = URL.createObjectURL(audioBlob);
          console.log('Created audio URL:', audioUrl);
          // 3. Set the source and play
          audioPlayer.src = audioUrl;
          try {
            await audioPlayer.play();
            setStatus('Audio stream received and playing successfully.', false);
          } catch (playError) {
            setStatus(`Audio playback failed: ${playError.message}`, true);
            URL.revokeObjectURL(audioUrl);
            console.error('Audio playback failed:', playError);
          }

          // Cleanup the temporary URL after the audio finishes playing
          audioPlayer.onended = () => {
            URL.revokeObjectURL(audioUrl);
            setStatus('Playback finished. Ready for new input.', false);
          };
        } catch (error) {
          setStatus(`A network error occurred: ${error.message}`, true);
          console.error('Fetch or playback failed:', error);
        } finally {
          toggleLoading(false);
        }
      });
    </script>
  </body>
</html>
